<?php
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\group\Entity\GroupContent;
use Drupal\Core\Form\FormStateInterface;
use Drupal\node\Entity\Node;

/*function csis_helpers_preprocess_group(&$build){
  $build['#attached']['drupalSettings']['csisHelpers']['entityinfo'] = csis_helpers_group_entity_info($build['group']);
  $vars['content']['#attached']['library'][] = 'csis_helpers/entity_info_helpers';
}

function csis_helpers_preprocess_node(&$build){
  $build['#attached']['drupalSettings']['csisHelpers']['entityinfo'] = csis_helpers_node_entity_info($build['node']);
    $vars['content']['#attached']['library'][] = 'csis_helpers/entityinfo_helpers';
}*/

function csis_helpers_node_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode){
 
  $build['#attached']['drupalSettings']['csisHelpers']['entityinfo'] = csis_helpers_node_entity_info($entity);
  $build['#attached']['library'][] = 'csis_helpers/entityinfo_helpers';

}

function csis_helpers_group_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode){
  $build['#attached']['drupalSettings']['csisHelpers']['entityinfo'] = csis_helpers_group_entity_info($entity);
  $build['#attached']['library'][] = 'csis_helpers/entityinfo_helpers';
}

function csis_helpers_form_node_form_alter (&$form, $form_state, $form_id){
  //attach node-id and if group node group-id to drupalSettings

  $entity = $form_state->GetFormObject()->getEntity();
  if($entity->id()){
    $form['#attached']['drupalSettings']['csisHelpers']['entityinfo'] = csis_helpers_node_entity_info($entity);
  }
}

function csis_helpers_form_group_form_alter (&$form, $form_state, $form_id){
  //attach group node grout-id to drupalSettings
  $entity = $form_state->GetFormObject()->getEntity();
  if($entity->id()){
   $form['#attached']['drupalSettings']['csisHelpers']['entityinfo'] = csis_helpers_group_entity_info($entity);
   $form['#attached']['library'][] = 'cisis_helpers/entity_info_helpers';

  }
}

function csis_helpers_preprocess_views_view(&$variables) {
  
  $view = $variables['view'];
  if ($view->id() == 'data_packages' && $view->current_display == 'browser'){ 
     $variables['#attached']['library'][] = 'csis_helpers/entitybrowser_helpers';
  }
  if ($view->id() == 'step_data' && $view->current_display == 'block_1'){
     $variables['#attached']['library'][] = 'csis_helpers/stepdata_helpers';
  }
}

function csis_js_alter(&$javascript, \Drupal\Core\Asset\AttachedAssetsInterface $assets){
//  kint($javascript);
}



function csis_helpers_node_entity_info(\Drupal\Core\Entity\EntityInterface $entity){
  $groupid = array();
  $relations = GroupContent::loadByEntity($entity);
  foreach ( $relations as $relation) {
    $groupid[] = $relation->getGroup()->id();
  }
  $entityinfo = array('step'=> $entity->id(), 'study'=> $groupid[0]);
  return $entityinfo;
}

function csis_helpers_group_entity_info(\Drupal\Core\Entity\EntityInterface $entity){
  $entityinfo = array('step'=> null, 'study'=> $entity->id());
  return $entityinfo;
}


